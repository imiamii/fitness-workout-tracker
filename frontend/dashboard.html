<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FitTrack | Dashboard</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="brand"><span class="dot"></span>FitTrack</div>
      <div class="nav">
        <a href="index.html">Home</a>
        <a href="dashboard.html">Dashboard</a>
        <a href="workout_creator.html">New Workout</a>
        <a href="#" id="logoutLink">Logout</a>
      </div>
    </div>

    <div class="grid">
      <div class="card" style="grid-column: span 4;">
        <h3>Profile</h3>
        <p class="tiny">Logged in as</p>
        <div class="pill" id="meLine">Loading...</div>
        <div class="divider"></div>

        <h3>Stats</h3>
        <p class="tiny">Weekly overview of your training.</p>
        <div class="divider"></div>
        <div class="pill">Total workouts: <b id="statCount">0</b></div>
        <div style="height: 10px;"></div>
        <div class="pill">Total volume (kg): <b id="statVolume">0</b></div>
        <div style="height: 10px;"></div>
        <div class="pill">Avg reps: <b id="statReps">0</b></div>

        <div class="msg" id="statsMsg"></div>
      </div>

      <div class="card" style="grid-column: span 8;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
          <div>
            <h2 style="margin-bottom:6px;">Workout History</h2>
            <div class="tiny">See what you’ve done and stay consistent.</div>
          </div>
          <a class="btn" href="workout_creator.html">+ New Workout</a>
        </div>

        <div class="divider"></div>
        <div id="workoutList" class="grid" style="margin-top:0;"></div>
        <div class="msg" id="listMsg"></div>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    requireAuth();
    document.getElementById('logoutLink').onclick = (e) => { e.preventDefault(); logout(); };

    async function loadMe() {
      const me = await api('/me');
      setText('meLine', `${me.username} • ${me.email}`);
    }

    async function loadStats() {
      const userId = getUserId();
      const msg = document.getElementById('statsMsg');
      msg.textContent = '';
      try {
        const data = await api(`/analytics/summary/${userId}`);
        setText('statCount', data.total_workouts);
        setText('statVolume', data.total_volume);
        setText('statReps', data.avg_reps);
      } catch (e) {
        msg.className = 'msg bad';
        msg.textContent = e.message;
      }
    }

    function workoutCard(w) {
      const date = w.date ? new Date(w.date).toLocaleString() : '';
      const ex = Array.isArray(w.exercises) ? w.exercises : [];

      const lines = ex.length
        ? ex.map(e => `<div class="tiny">• ${e.name}: ${e.sets}×${e.reps} @ ${e.weight}kg</div>`).join('')
        : `<div class="tiny muted">No exercises yet.</div>`;

      return `
        <div class="card workout" style="grid-column: span 6;">
          <button class="xbtn" title="Delete workout" onclick="deleteWorkout('${w.id}')">×</button>
          <h3>${w.title}</h3>
          <div class="tiny muted">${date}</div>
          <div class="divider"></div>
          ${lines}
        </div>
      `;
    }

    async function loadWorkouts() {
      const userId = getUserId();
      const list = document.getElementById('workoutList');
      const msg = document.getElementById('listMsg');
      msg.textContent = 'Loading...';
      msg.className = 'msg';

      try {
        const workouts = await api(`/users/${userId}/workouts`);
        list.innerHTML = workouts.map(workoutCard).join('');
        msg.textContent = workouts.length ? '' : 'No workouts yet. Create your first one.';
      } catch (e) {
        msg.className = 'msg bad';
        msg.textContent = e.message;
      }
    }

    async function deleteWorkout(id) {
      if (!confirm('Delete this workout?')) return;
      try {
        await api(`/workouts/${id}`, { method: 'DELETE' });
        await loadWorkouts();
        await loadStats();
      } catch (e) {
        alert(e.message);
      }
    }

    // Expose to window for inline onclick
    window.deleteWorkout = deleteWorkout;

    (async () => {
      await loadMe();
      await loadStats();
      await loadWorkouts();
    })();
  </script>
</body>
</html>
